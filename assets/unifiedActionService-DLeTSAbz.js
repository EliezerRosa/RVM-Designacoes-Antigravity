import{s as A,a as P,g as k,E as l,c as $,w as h}from"./index-C4EgQJ-s.js";const U={async executeDesignation(a,i,o,e){console.log("[UnifiedAction] üìù Solicita√ß√£o de Designa√ß√£o:",{partId:a,publisherName:i,source:o,reason:e});try{o==="AGENT"&&await this.validateEligibility(a,i);const t=await h.proposePublisher(a,i);return console.log(`[UnifiedAction] ‚úÖ Sucesso: ${i} designado para ${t.tituloParte} (${o})`),{success:!0,part:t}}catch(t){return console.error("[UnifiedAction] ‚ùå Falha:",t),{success:!1,error:t instanceof Error?t.message:"Erro desconhecido na designa√ß√£o"}}},async revertDesignation(a,i,o="Revertido pelo usu√°rio"){console.log("[UnifiedAction] ‚Ü©Ô∏è Solicita√ß√£o de Revers√£o:",{partId:a,source:i,reason:o});try{const e=await h.rejectProposal(a,o);return console.log(`[UnifiedAction] ‚úÖ Revertido com sucesso: ${e.tituloParte}`),{success:!0,part:e}}catch(e){return console.error("[UnifiedAction] ‚ùå Falha na revers√£o:",e),{success:!1,error:e instanceof Error?e.message:"Erro desconhecido na revers√£o"}}},async validateEligibility(a,i){const o=a.trim(),{data:e,error:t}=await A.from("workbook_parts").select("week_id, seq, tipo_parte, modalidade, date, section, funcao, part_title").eq("id",o).single();if(t||!e)throw console.error(`[UnifiedAction] Erro buscando parte ${o}:`,t),new Error(`Parte n√£o encontrada: "${o}". Detalhe: ${t?.message||"Registro inexistente"}`);const d=await P.loadPublishers(),u=d.find(r=>r.name===i);if(!u)throw new Error(`Publicador n√£o encontrado: "${i}"`);const f=e.tipo_parte||"",_=e.modalidade||k(f),p=e.funcao==="Ajudante"?l.AJUDANTE:l.TITULAR,v=f.toLowerCase().includes("inicial"),b=!1;let s;if(p===l.AJUDANTE){const{data:r}=await A.from("workbook_parts").select("part_title, resolved_publisher_name").eq("week_id",e.week_id).eq("funcao","Titular");if(r&&r.length>0){const w=e.part_title||"",m=w.replace(/\s*-\s*Ajudante.*/i,"").replace(/\(Ajudante\)/i,"").trim().toLowerCase(),c=r.find(n=>(n.part_title||"").toLowerCase().includes(m));if(c?.resolved_publisher_name){const n=d.find(E=>E.name.trim()===c.resolved_publisher_name.trim());n&&(s=n.gender),console.log(`[UnifiedAction] Titular encontrado via fuzzy match: ${c.resolved_publisher_name} (${s})`)}else console.warn(`[UnifiedAction] Titular N√ÉO encontrado para Ajudante: ${w} (Base: ${m})`)}}const g=$(u,_,p,{date:e.date,isOracaoInicial:v,secao:e.section,isPastWeek:b,titularGender:s});if(!g.eligible)throw new Error(`[Safety Block] Publicador Ineleg√≠vel: ${g.reason}`)}};export{U as unifiedActionService};
