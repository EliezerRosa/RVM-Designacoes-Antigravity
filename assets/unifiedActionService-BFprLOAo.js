import{s as A,a as _,g as k,E as w,c as $,w as b}from"./index-COIIrzuz.js";const U={async executeDesignation(a,o,t,e,r){console.log("[UnifiedAction] üìù Solicita√ß√£o de Designa√ß√£o:",{partId:a,publisherName:o,source:t,reason:e});try{let i=r;if(!i&&o){const c=(await _.loadPublishers()).find(l=>l.name.trim().toLowerCase()===o.trim().toLowerCase());c&&(i=c.id)}t==="AGENT"&&await this.validateEligibility(a,o);const s=await b.proposePublisher(a,o,i);return console.log(`[UnifiedAction] ‚úÖ Sucesso: ${o} designado para ${s.tituloParte} (${t})`),{success:!0,part:s}}catch(i){return console.error("[UnifiedAction] ‚ùå Falha:",i),{success:!1,error:i instanceof Error?i.message:"Erro desconhecido na designa√ß√£o"}}},async revertDesignation(a,o,t="Revertido pelo usu√°rio"){console.log("[UnifiedAction] ‚Ü©Ô∏è Solicita√ß√£o de Revers√£o:",{partId:a,source:o,reason:t});try{const e=await b.rejectProposal(a,t);return console.log(`[UnifiedAction] ‚úÖ Revertido com sucesso: ${e.tituloParte}`),{success:!0,part:e}}catch(e){return console.error("[UnifiedAction] ‚ùå Falha na revers√£o:",e),{success:!1,error:e instanceof Error?e.message:"Erro desconhecido na revers√£o"}}},async validateEligibility(a,o){const t=a.trim(),{data:e,error:r}=await A.from("workbook_parts").select("week_id, seq, tipo_parte, modalidade, date, section, funcao, part_title").eq("id",t).single();if(r||!e)throw console.error(`[UnifiedAction] Erro buscando parte ${t}:`,r),new Error(`Parte n√£o encontrada: "${t}". Detalhe: ${r?.message||"Registro inexistente"}`);const i=await _.loadPublishers(),s=i.find(n=>n.name===o);if(!s)throw new Error(`Publicador n√£o encontrado: "${o}"`);const u=e.tipo_parte||"",c=e.modalidade||k(u),l=e.funcao==="Ajudante"?w.AJUDANTE:w.TITULAR,v=u.toLowerCase().includes("inicial"),P=!1;let f;if(l===w.AJUDANTE){const{data:n}=await A.from("workbook_parts").select("part_title, resolved_publisher_name").eq("week_id",e.week_id).eq("funcao","Titular");if(n&&n.length>0){const m=e.part_title||"",h=m.replace(/\s*-\s*Ajudante.*/i,"").replace(/\(Ajudante\)/i,"").trim().toLowerCase(),p=n.find(d=>(d.part_title||"").toLowerCase().includes(h));if(p?.resolved_publisher_name){const d=i.find(E=>E.name.trim()===p.resolved_publisher_name.trim());d&&(f=d.gender),console.log(`[UnifiedAction] Titular encontrado via fuzzy match: ${p.resolved_publisher_name} (${f})`)}else console.warn(`[UnifiedAction] Titular N√ÉO encontrado para Ajudante: ${m} (Base: ${h})`)}}const g=$(s,c,l,{date:e.date,isOracaoInicial:v,secao:e.section,isPastWeek:P,titularGender:f});if(!g.eligible)throw new Error(`[Safety Block] Publicador Ineleg√≠vel: ${g.reason}`)}};export{U as unifiedActionService};
